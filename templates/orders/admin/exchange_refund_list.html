{% extends "base.html" %}
{% load static %}
{% load product_filters %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/admin/product_list.css' %}">
<link rel="stylesheet" href="{% static 'css/admin/order_list.css' %}">
<link rel="stylesheet" href="{% static 'css/admin/cancellation_list.css' %}">
<link rel="stylesheet" href="{% static 'css/admin/exchange_refund_list.css' %}">
{% endblock %}

{% block content %}
<div class="admin-layout">
    {% include "admin/sidebar.html" %}

    <div class="admin-main-content">
        <div class="admin-container">
            <div class="admin-header">
                <h1 class="admin-title">교환/반품 요청 관리</h1>
            </div>

            <div class="exchange-refund-stats-section">
                <div class="section-header">
                    <h3>교환/반품 현황</h3>
                </div>
                <div class="exchange-refund-stats">
                    <a href="?status=PENDING{% if q %}&q={{ q|urlencode }}{% endif %}" class="stat-card stat-pending {% if status == 'PENDING' %}active{% endif %}">
                        <span class="stat-number">{{ exchange_refund_stats.pending }}</span>
                        <span class="stat-label">대기중</span>
                    </a>
                    <a href="?status=APPROVED{% if q %}&q={{ q|urlencode }}{% endif %}" class="stat-card stat-approved {% if status == 'APPROVED' %}active{% endif %}">
                        <span class="stat-number">{{ exchange_refund_stats.approved }}</span>
                        <span class="stat-label">승인</span>
                    </a>
                    <a href="?status=REJECTED{% if q %}&q={{ q|urlencode }}{% endif %}" class="stat-card stat-rejected {% if status == 'REJECTED' %}active{% endif %}">
                        <span class="stat-number">{{ exchange_refund_stats.rejected }}</span>
                        <span class="stat-label">거부</span>
                    </a>
                </div>
            </div>

            <div class="order-list exchange-refund-list">
                <div class="list-header">
                    <div class="list-info">
                        <span>총 {{ page_obj.paginator.count }}건</span>
                        {% if status %}<span class="filter-badge">필터: {% if status == "PENDING" %}대기중{% elif status == "APPROVED" %}승인{% else %}거부{% endif %}</span>{% endif %}
                    </div>
                    <div class="list-actions">
                        <form method="get" class="order-list-search">
                            <select name="status" class="filter-select">
                                <option value="">전체 상태</option>
                                <option value="PENDING" {% if status == "PENDING" %}selected{% endif %}>대기중</option>
                                <option value="APPROVED" {% if status == "APPROVED" %}selected{% endif %}>승인</option>
                                <option value="REJECTED" {% if status == "REJECTED" %}selected{% endif %}>거부</option>
                            </select>
                            <input type="text" name="q" value="{{ q }}" placeholder="주문번호·이메일·상품명 검색" class="filter-select order-list-search-input">
                            <button type="submit" class="btn btn-sm btn-secondary">검색</button>
                        </form>
                    </div>
                </div>

                <div class="order-list-body">
                    <table class="order-table exchange-refund-table">
                        <colgroup>
                            <col class="col-order-id">
                            <col class="col-customer">
                            <col class="col-items">
                            <col class="col-amount">
                            <col class="col-date">
                            <col class="col-type">
                            <col class="col-reason">
                            <col class="col-status">
                            <col class="col-action">
                        </colgroup>
                        <thead>
                            <tr>
                                <th>주문번호</th>
                                <th>고객</th>
                                <th>상품</th>
                                <th>주문금액</th>
                                <th>요청일시</th>
                                <th>유형</th>
                                <th>사유</th>
                                <th>상태</th>
                                <th>처리</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            {% with items_count=order.items.all|length %}
                            <tr class="order-row order-row-clickable" data-order-number="{{ order.order_id }}">
                                <td class="order-id-cell"><span class="order-id" title="{{ order.order_id }}">{{ order.order_id }}</span></td>
                                <td class="customer-cell">
                                    <div class="customer-info">
                                        <div class="customer-email">{{ order.user.email }}</div>
                                        <div class="customer-name">
                                            {% if order.user.first_name or order.user.last_name %}
                                                {{ order.user.last_name }}{{ order.user.first_name }}
                                            {% else %}
                                                {{ order.user.username }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="order-items-cell">
                                    <span class="order-items-count">{{ items_count }}개 상품</span>
                                </td>
                                <td class="order-amount-cell">
                                    <div class="order-amount">{{ order.total_amount|floatformat:0|intcomma }}원</div>
                                </td>
                                <td class="order-date-cell">
                                    <div class="order-date">{{ order.exchange_refund_requested_at|date:"Y-m-d H:i" }}</div>
                                </td>
                                <td class="type-cell">
                                    {% if order.exchange_refund_type == "EXCHANGE" %}
                                    <span class="type-badge type-exchange">교환</span>
                                    {% elif order.exchange_refund_type == "REFUND" %}
                                    <span class="type-badge type-refund">환불</span>
                                    {% else %}
                                    <span class="cell-dash">-</span>
                                    {% endif %}
                                </td>
                                <td class="reason-cell">
                                    {% if order.exchange_refund_reason %}
                                    <span class="reason-text" title="{{ order.get_exchange_refund_reason_display }}">{{ order.get_exchange_refund_reason_display }}</span>
                                    {% else %}
                                    <span class="cell-dash">-</span>
                                    {% endif %}
                                </td>
                                <td class="status-text-cell">
                                    {% if order.exchange_refund_request_status == "APPROVED" %}
                                        교환/반품승인
                                    {% elif order.exchange_refund_request_status == "REJECTED" %}
                                        교환/반품거부
                                    {% else %}
                                        교환/반품요청
                                    {% endif %}
                                </td>
                                <td class="cancellation-action-cell">
                                    {% if order.exchange_refund_request_status == "PENDING" %}
                                    <div class="cancellation-actions exchange-refund-actions" data-no-row-click>
                                        <button type="button" class="btn btn-xs btn-success" onclick="event.stopPropagation(); showApprovalModal({{ order.id }}, '{{ order.order_id }}')">승인</button>
                                        <button type="button" class="btn btn-xs btn-danger" onclick="event.stopPropagation(); showRejectModal({{ order.id }}, '{{ order.order_id }}')">거부</button>
                                    </div>
                                    {% else %}
                                    <div class="cancellation-processed-info">
                                        {% if order.exchange_refund_admin_note %}
                                        <div class="admin-note">{{ order.exchange_refund_admin_note|truncatewords:5 }}</div>
                                        {% endif %}
                                        <div class="processed-date">{{ order.exchange_refund_processed_at|date:"Y-m-d H:i" }}</div>
                                    </div>
                                    {% endif %}
                                    <div class="admin-memo-content" style="display:none">{% if order.exchange_refund_admin_note %}{{ order.exchange_refund_admin_note }}{% endif %}</div>
                                </td>
                            </tr>
                            {% endwith %}
                            {% empty %}
                            <tr class="order-table-empty">
                                <td colspan="9">조회된 교환/반품 요청이 없습니다.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    {% if page_obj.paginator.num_pages > 1 %}
                    <div class="order-pagination">
                        {% if page_obj.has_previous %}
                            <a class="btn btn-sm btn-secondary" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&status={{ status }}">이전</a>
                        {% endif %}
                        <span class="order-pagination-info">
                            {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                        </span>
                        {% if page_obj.has_next %}
                            <a class="btn btn-sm btn-secondary" href="?page={{ page_obj.next_page_number }}&q={{ q }}&status={{ status }}">다음</a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="approvalModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>교환/반품 요청 승인</h3>
            <span class="close" onclick="closeModal('approvalModal')">&times;</span>
        </div>
        <form method="post" id="approvalForm" action="">
            {% csrf_token %}
            <input type="hidden" name="action" value="approve">
            <div class="modal-body">
                <p>주문번호: <strong id="approvalOrderNumber"></strong></p>
                <div class="form-group">
                    <label for="approvalAdminNote">관리자 메모 (선택)</label>
                    <textarea name="admin_note" id="approvalAdminNote" rows="3" placeholder="관리자 메모를 입력하세요 (선택사항)"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('approvalModal')">취소</button>
                <button type="submit" class="btn btn-success">승인</button>
            </div>
        </form>
    </div>
</div>

<div id="rejectModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>교환/반품 요청 거부</h3>
            <span class="close" onclick="closeModal('rejectModal')">&times;</span>
        </div>
        <form method="post" id="rejectForm" action="">
            {% csrf_token %}
            <input type="hidden" name="action" value="reject">
            <div class="modal-body">
                <p>주문번호: <strong id="rejectOrderNumber"></strong></p>
                <div class="form-group">
                    <label for="rejectAdminNote">거부 사유 <span class="required">*</span></label>
                    <textarea name="admin_note" id="rejectAdminNote" rows="3" placeholder="거부 사유를 입력해주세요" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('rejectModal')">취소</button>
                <button type="submit" class="btn btn-danger">거부</button>
            </div>
        </form>
    </div>
</div>

<div id="adminMemoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>관리자 메모</h3>
            <span class="close" onclick="closeModal('adminMemoModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p>주문번호: <strong id="adminMemoOrderNumber"></strong></p>
            <div class="form-group">
                <label>관리자 메모</label>
                <div id="adminMemoContent" class="admin-memo-display"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('adminMemoModal')">닫기</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/admin/exchange_refund_list.js' %}"></script>
{% endblock %}
