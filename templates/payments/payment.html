{% extends "base.html" %}
{% load static %}
{% load product_filters %}

{% block title %}결제하기 - SeoSeung-Soo{% endblock %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/payments/payments.css' %}">
{% endblock %}

{% block content %}
<div class="payment-container">
    <div class="order-form">
        <div class="form-section">
        <div class="delivery-info-container">
            <div class="delivery-header">
                <h3 class="section-title">배송 정보</h3>
            </div>

            <form class="delivery-form">
                <div class="form-row">
                    <div class="form-label-cell">
                        <label class="form-label">받는사람<span class="required">*</span></label>
                    </div>
                    <div class="form-input-cell">
                        <input type="text" id="recipientName" class="form-input" placeholder="이름을 입력해주세요" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-label-cell">
                        <label class="form-label">주소 <span class="required">*</span></label>
                    </div>
                    <div class="form-input-cell">
                        <div class="address-container">
                            <div class="postal-code-section">
                                <input type="text" class="form-input postal-code-input" placeholder="우편번호" readonly>
                                <button type="button" class="address-search-btn">주소검색</button>
                            </div>
                            <input type="text" class="form-input address-input" placeholder="기본주소" readonly>
                            <input type="text" class="form-input detail-address-input" placeholder="나머지 주소(선택 입력 가능)">
                        </div>
                    </div>
                </div>
            
            <div class="form-row">
                <div class="form-label-cell">
                    <label class="form-label">휴대전화 <span class="required">*</span></label>
                </div>
                <div class="form-input-cell">
                    <div class="phone-input-wrapper">
                        <input type="tel" id="phone1" class="form-input phone-input" placeholder="010" maxlength="3" required>
                        <span class="phone-separator">-</span>
                        <input type="tel" id="phone2" class="form-input phone-input" placeholder="1234" maxlength="4" required>
                        <span class="phone-separator">-</span>
                        <input type="tel" id="phone3" class="form-input phone-input" placeholder="5678" maxlength="4" required>
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-label-cell">
                    <label class="form-label">이메일 <span class="required">*</span></label>
                </div>
                <div class="form-input-cell">
                    <div class="email-input-wrapper">
                        <input type="text" id="emailId" class="form-input email-input" placeholder="example" required>
                        <span class="email-at">@</span>
                        <select id="emailDomain" class="form-input email-domain">
                            <option value="naver.com">naver.com</option>
                            <option value="gmail.com">gmail.com</option>
                            <option value="daum.net">daum.net</option>
                            <option value="yahoo.com">yahoo.com</option>
                            <option value="custom">직접입력</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-label-cell">
                </div>
                <div class="form-input-cell">
                    <label class="checkbox-label">
                        <input type="checkbox" class="checkbox-input">
                        <span class="checkbox-text">기본 배송지로 저장</span>
                    </label>
                </div>
            </div>
            </form>
        </div>
        </div>
        <div class="order-items-container">
        <div class="form-section">
            <h3 class="section-title">주문상품</h3>
            <div class="order-items">
                {% if order and order_items_with_products %}
                    {% for item_data in order_items_with_products %}
                    {% with item=item_data.item product=item_data.product %}
                    <div class="order-item">
                        {% if product and product.image.all %}
                            <img src="{{ product.image.first.image.url }}" alt="{{ item.product_name }}" class="item-image">
                        {% else %}
                            <div class="item-image no-image">이미지 없음</div>
                        {% endif %}
                        <div class="item-info">
                            {% if product %}
                                <h3 class="item-name" onclick="window.location.href='{% url 'products-detail' product.name|product_slug %}'" style="cursor: pointer;">{{ product.name }}</h3>
                            {% else %}
                                <h3 class="item-name">{{ item.product_name }}</h3>
                            {% endif %}
                            <div class="item-quantity">수량: {{ item.quantity }}개</div>
                            {% if item.color_id and product %}
                                {% for color in product.colors.all %}
                                    {% if color.id == item.color_id %}
                                    <div class="item-color">
                                        <span class="item-color-circle" style="background-color: {% if color.hex_code %}{{ color.hex_code }}{% else %}#e5e7eb{% endif %};" title="{{ color.name }}"></span>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif product and product.colors.all %}
                                {% for color in product.colors.all %}
                                <div class="item-color">
                                    <span class="item-color-circle" style="background-color: {% if color.hex_code %}{{ color.hex_code }}{% else %}#e5e7eb{% endif %};" title="{{ color.name }}"></span>
                                </div>
                                {% endfor %}
                            {% endif %}
                            <div class="item-price">
                                {% if product %}
                                    {% if product.sale_price %}
                                        <span class="sale-price">{{ product.price|discount_amount:product.sale_price|intcomma }}원</span>
                                        <span class="original-price">{{ product.price|intcomma }}원</span>
                                    {% else %}
                                        <span class="current-price">{{ product.price|intcomma }}원</span>
                                    {% endif %}
                                {% else %}
                                    <span class="current-price">{{ item.unit_price|intcomma }}원</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    {% endfor %}
                {% else %}
                <div class="order-item">
                    <div class="item-info">
                        <div class="item-name">주문 정보가 없습니다.</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="discount-info-container">
        <div class="form-section">
            <div class="discount-section">
                <h4 class="discount-title">포인트/쿠폰</h4>
                
                <div class="point-section">
                    <div class="point-header">
                        <span class="point-label">포인트 사용</span>
                        <span class="point-balance">보유 <strong id="availablePoints">{{ point_balance|intcomma }}</strong>P</span>
                    </div>
                    <div class="point-input-group">
                        <input type="number" id="pointInput" class="point-input" placeholder="0" min="0" max="{{ point_balance }}" value="0"
                               data-max-point="{{ point_balance }}" data-final-amount="{{ final_amount }}">
                        <span class="point-unit">P</span>
                        <button type="button" class="point-use-all-btn" id="useAllPointsBtn">전액사용</button>
                    </div>
                    <p class="point-notice">* 최소 1,000P 이상부터 사용 가능하며, 전액 포인트 결제가 가능합니다.</p>
                </div>

                <div class="discount-item">
                    <span class="discount-label">자동 할인</span>
                    <select class="discount-select">
                        <option value="0">할인 없음</option>
                    </select>
                </div>
                <div class="coupon-section">
                    <span class="coupon-label">할인코드 적용</span>
                    <div class="coupon-input-group">
                        <input type="text" class="coupon-input" placeholder="할인코드 입력">
                        <button type="button" class="coupon-btn">코드 적용</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <div class="payment-info-container">
            <div class="payment-summary-container">
                <div class="section-header">
                    <h3>주문 요약</h3>
                </div>
                {% if order %}
                    <div class="summary-content">
                        <div class="summary-row">
                            <span class="label">상품 금액:</span>
                            <span class="value">{{ actual_total|intcomma }}원</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">배송비:</span>
                            <span class="value">
                                {% if shipping_fee == 0 %}
                                    무료
                                {% else %}
                                    {{ shipping_fee|intcomma }}원
                                {% endif %}
                            </span>
                        </div>
                        <div class="summary-row point-discount-row" style="display: none;">
                            <span class="label">포인트 사용:</span>
                            <span class="value point-discount-value">-0원</span>
                        </div>
                        <div class="summary-row total">
                            <span class="label">총 결제 금액:</span>
                            <span class="value" id="finalAmountDisplay">{{ final_amount|intcomma }}원</span>
                        </div>
                    </div>
                {% else %}
                    <div class="summary-content">
                        <div class="summary-row">
                            <span class="label">상품 금액:</span>
                            <span class="value">0원</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">배송비:</span>
                            <span class="value">0원</span>
                        </div>
                        <div class="summary-row total">
                            <span class="label">총 결제 금액:</span>
                            <span class="value">0원</span>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="payment-method-container">
            <div class="form-section">
                <h3 class="section-title">결제 수단</h3>
                <div class="payment-method-options">
                    <label class="payment-method-option selected" data-method="card">
                        <input type="radio" name="payment-method" value="card" checked>
                        <div class="option-content">
                            <span class="option-text">카드 결제</span>
                            <span class="option-desc">토스페이먼츠</span>
                        </div>
                        <span class="check-icon">✓</span>
                    </label>
                    <label class="payment-method-option" data-method="virtual">
                        <input type="radio" name="payment-method" value="virtual">
                        <div class="option-content">
                            <span class="option-text">무통장 입금</span>
                            <span class="option-desc">가상계좌</span>
                        </div>
                        <span class="check-icon">✓</span>
                    </label>
                </div>

                <div class="virtual-account-section" id="virtualAccountSection" style="display: none;">
                    <div class="bank-select-wrapper">
                        <label class="bank-select-label">입금 은행 선택</label>
                        <select class="bank-select" id="bankSelect">
                            <option value="">은행을 선택해주세요</option>
                            {% for code, name in bank_choices %}
                            <option value="{{ code }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="depositor-name-wrapper">
                        <label class="depositor-name-label">입금자명</label>
                        <input type="text" class="depositor-name-input" id="depositorName" placeholder="입금자명을 입력해주세요">
                    </div>
                    <div class="virtual-account-notice">
                        <p>• 가상계좌는 주문 건당 고유 계좌번호가 발급됩니다.</p>
                        <p>• 발급된 계좌번호로 24시간 내에 입금해주세요.</p>
                        <p>• 입금 확인 후 자동으로 결제가 완료됩니다.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="payment-button-container">
        <div class="payment-section">
            {% if pre_order_key %}
                <button type="button" class="payment-button" id="tossPaymentBtn" data-pre-order-key="{{ pre_order_key }}" data-amount="{{ final_amount }}">
                    <span class="payment-text">{{ final_amount|intcomma }}원 결제하기</span>
                </button>
            {% else %}
                <button type="button" class="payment-button" disabled>
                    <span class="payment-text">{% if error %}{{ error }}{% else %}주문 정보가 없습니다.{% endif %}</span>
                </button>
            {% endif %}
            <div class="terms-agreement">
                <p>결제하기 버튼을 클릭하시면 <a href="#">이용약관</a> 및 <a href="#">개인정보처리방침</a>에 동의하는 것으로 간주됩니다.</p>
            </div>
        </div>
        </div>
        </div>
    </div>
</div>

<input type="hidden" id="tossClientKey" value="{% if TOSS_CLIENT_KEY %}{{ TOSS_CLIENT_KEY }}{% endif %}">
{% if pre_order_key %}
<input type="hidden" id="preOrderKey" value="{{ pre_order_key }}">
<input type="hidden" id="orderAmount" value="{{ final_amount }}">
{% endif %}

{% endblock %}

{% block scripts %}
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://js.tosspayments.com/v1/payment"></script>
<script src="{% static 'js/payments/payments.js' %}" defer></script>
{% endblock %}