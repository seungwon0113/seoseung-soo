{% extends "base.html" %}
{% load static %}
{% load product_filters %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/products/detail.css' %}">
<link rel="stylesheet" href="{% static 'css/products/product_description.css' %}">
<link rel="stylesheet" href="{% static 'css/products/review.css' %}">
<link rel="stylesheet" href="{% static 'css/products/review_3d.css' %}">
{% endblock %}

{% block content %}
<div class="product-detail-container">
    <div class="products-detail">
        <div class="product-images">
            {% if products.image.all %}
                <div class="main-image">
                    <img src="{{ products.image.first.image.url }}" alt="{{ products.name }}" id="mainImage">
                </div>
                {% if products.image.count > 1 %}
                <div class="thumbnail-images">
                    {% for image in products.image.all %}
                    <img src="{{ image.image.url }}" alt="{{ products.name }}" class="thumbnail" onclick="changeMainImage('{{ image.image.url }}')">
                    {% endfor %}
                </div>
                {% endif %}
            {% else %}
                <div class="no-image">
                    <span>이미지 없음</span>
                </div>
            {% endif %}
        </div>
        
        <div class="product-info">
            <h1 class="product-name">{{ products.name }}</h1>
            <p class="product-description">{{ products.description }}</p>
            
            <div class="color-selection-section">
                <div class="color-selection-options">
                    {% for color in products.colors.all %}
                    <button class="color-option-btn{% if forloop.first %} active{% endif %}" data-color="{{ color.id }}">
                        <span class="color-circle" style="background-color: {% if color.hex_code %}{{ color.hex_code }}{% else %}#e5e7eb{% endif %};" title="{{ color.name }}"></span>
                    </button>
                    {% endfor %}
                </div>
            </div>
            
            <div class="price-section">
                {% if products.sale_price %}
                    <div class="price-row">
                        <span class="sale-price">{{ products.price|discount_amount:products.sale_price|intcomma }}원</span>
                        <span class="original-price">{{ products.price|intcomma }}원</span>
                        <span class="discount-rate">{{ products.sale_price|intcomma }}원 할인</span>
                    </div>
                {% else %}
                    <div class="price-row">
                        <span class="price">{{ products.price|intcomma }}원</span>
                    </div>
                {% endif %}
            </div>
            
            <div class="size-quantity-section" data-product-stock="{{ products.stock }}">
                {% if products.sizes.exists %}
                <div class="size-selection">
                    <div class="size-options">
                        {% for size in products.sizes.all %}
                        <button type="button" class="size-btn" data-size="{{ size.name }}" data-size-id="{{ size.id }}">{{ size.name }}</button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                <div class="quantity-selection">
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="decreaseQuantity()">-</button>
                        <span class="quantity-display" id="quantityDisplay">1</span>
                        <button class="quantity-btn" onclick="increaseQuantity()">+</button>
                    </div>
                </div>
            </div>
            
            <div class="product-actions">
                {% if products.is_live and not products.is_sold %}
                    <div class="primary-action">
                        <button
                            class="btn btn-primary btn-large"
                            id="buyNowButton"
                            data-product-id="{{ products.id }}"
                            data-is-authenticated="{{ user.is_authenticated|yesno:'true,false' }}"
                            data-login-url="{% url 'login' %}"
                        >
                            즉시 구매
                        </button>
                    </div>
                    <div class="secondary-actions">
                        {% if user.is_authenticated %}
                            <form method="post" action="{% url 'cart-create' %}" class="cart-form">
                                {% csrf_token %}
                                <input type="hidden" name="product_id" value="{{ products.id }}">
                                <input type="hidden" name="quantity" id="cartQuantity" value="1">
                                {% if products.colors.first %}
                                <input type="hidden" name="color_id" id="selectedColorId" value="{{ products.colors.first.id }}">
                                {% else %}
                                <input type="hidden" name="color_id" id="selectedColorId" value="">
                                {% endif %}
                                <input type="hidden" name="size_id" id="selectedSizeId" value="">
                                <button type="submit" class="btn btn-secondary">장바구니 담기</button>
                            </form>
                        {% else %}
                            <a href="{% url 'login' %}" onclick="alert('로그인이 필요합니다.')" class="btn btn-secondary">장바구니 담기</a>
                        {% endif %}
                        
                        {% if user.is_authenticated %}
                            <form class="wishlist-form">
                                {% csrf_token %}
                                <button type="button" class="btn btn-secondary" onclick="addToWishlist({{ products.id }})" id="wishlist-btn-{{ products.id }}">
                                    {% if is_favorited %}찜하기 취소{% else %}찜하기{% endif %}
                                </button>
                            </form>
                        {% else %}
                            <a href="{% url 'login' %}" onclick="alert('로그인이 필요합니다.')" class="btn btn-secondary">찜하기</a>
                        {% endif %}
                    </div>
                {% else %}
                    <button class="btn btn-disabled btn-large" disabled>
                        {% if products.is_sold %}품절{% else %}판매 준비중{% endif %}
                    </button>
                {% endif %}
            </div>

            <div class="shipping-info">
                <div class="shipping-item">
                    <span class="shipping-label">국내·해외배송:</span>
                    <span class="shipping-value">국내배송</span>
                </div>
                <div class="shipping-item">
                    <span class="shipping-label">배송방법:</span>
                    <span class="shipping-value">택배</span>
                </div>
                <div class="shipping-item">
                    <span class="shipping-label">배송비:</span>
                    <span class="shipping-value">3,000원(50,000원 이상 구매 시 무료)</span>
                </div>
            </div>

        </div>
    </div>
    <div class="product-description-or-review-container">
        <div class="product-description-or-review-toggle">
            <button class="tab-button active" data-tab="description">상품 상세내용</button>
            <button class="tab-button" data-tab="review">리뷰 ({{ review_count|default:0 }})</button>
        </div>
        
        <div class="tab-content">
            <div class="tab-panel active" id="description">
                <div class="product-detail-content">
                    <h3>상품 상세 정보</h3>
                    <div class="detail-info">
                        <div class="info-item">
                            <span class="info-label">상품명:</span>
                            <span class="info-value">{{ products.name }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">상품 설명:</span>
                            <span class="info-value">{{ products.description }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">가격:</span>
                            <span class="info-value">{{ products.price|intcomma }}원</span>
                        </div>
                        {% if products.sale_price %}
                        <div class="info-item">
                            <span class="info-label">할인가:</span>
                            <span class="info-value">{{ products.sale_price|intcomma }}원</span>
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <span class="info-label">재고:</span>
                            <span class="info-value">{{ products.stock }}개</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">카테고리:</span>
                            <span class="info-value">
                                {% for category in products.categories.all %}
                                    {{ category.name }}{% if not forloop.last %}, {% endif %}
                                {% empty %}
                                    카테고리 없음
                                {% endfor %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-panel" id="review">
                {% if review_count > 0 %}
                <div class="review-sphere-container" id="reviewSphereContainer">
                    <div class="review-sphere-gradient-mask"></div>
                    <div class="review-spheres">
                        {% for review in reviews %}
                        <div class="review-sphere" data-review-id="{{ review.id }}" data-has-image="{% if review.user.profile_image %}true{% else %}false{% endif %}">
                            {% if review.user.profile_image %}
                                <img src="{{ review.user.profile_image }}" alt="{{ review.get_masked_username }}" class="sphere-profile-image">
                            {% else %}
                                <span class="avatar-text">S</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <button class="sphere-expand-btn" id="sphereExpandBtn">립볼 전체 보기</button>
                </div>
                

                <div class="review-modal" id="reviewModal">
                    <div class="modal-overlay"></div>
                    <button class="modal-close">×</button>
                    <button class="modal-nav-btn modal-prev" id="modalPrev">‹</button>
                    <button class="modal-nav-btn modal-next" id="modalNext">›</button>

                    <div class="modal-container">
                        <div class="modal-content">
                            <div class="modal-image-section">
                                <div class="modal-images" id="modalImages">
                                </div>
                            </div>

                            <div class="modal-detail-section">
                                <div class="modal-header">
                                    <div class="modal-user-info">
                                        <div class="modal-avatar" id="modalAvatar"></div>
                                        <div class="modal-username" id="modalUsername"></div>
                                    </div>
                                    <div class="modal-rating" id="modalRating"></div>
                                </div>

                                <div class="modal-body">
                                    <div class="modal-review-content">
                                        <div class="modal-review-text" id="modalReviewText"></div>
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <div class="modal-date" id="modalDate"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                <div class="review-summary">
                    <div class="review-summary-grid">
                        <div class="review-summary-section">
                            <div class="review-summary-label">상품만족도</div>
                            <div class="review-satisfaction">
                                <span class="rating-score">{{ avg_rating|floatformat:1 }}</span>
                                <span class="rating-total">/5</span>
                            </div>
                        </div>

                        <div class="review-summary-section">
                            <div class="review-summary-label">리뷰</div>
                            <div class="review-count-display">
                                <div class="review-count-items">
                                    <span class="review-count-total">전체 {{ review_count }}</span>
                                    <span class="review-count-label">포토 {{ photo_review_count|default:0 }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="review-summary-section">
                            <div class="review-summary-label">평점 분포</div>
                            <div class="review-stats-list">
                                {% for rating, data in rating_distribution.items %}
                                <div class="review-stat-item">
                                    <span class="review-stat-star">{{ rating }}점</span>
                                    <div class="review-stat-bar-container">
                                        <div class="review-stat-bar" style="width: {{ data.percentage }}%;"></div>
                                    </div>
                                    <span class="review-stat-percentage">{{ data.percentage }}%</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="review-summary-section review-write-call">
                            <span class="review-write-text">리뷰를 작성해서 립볼을 채워보세요!</span>
                            <button class="review-write-btn">리뷰 작성하기</button>
                        </div>
                    </div>
                </div>
                <div class="customer-review-content">
                    {% if review_count > 0 %}
                        {% for review in reviews %}
                            <div class="customer-review-grid">
                                <div class="customer-review-item">
                                    <div class="customer-review-item-section">
                                        <span class="customer-review-item-title">{{ review.get_masked_username }}</span>
                                        <span class="customer-review-item-rating-stars">{{ review.get_star_display }}</span>
                                        <span class="customer-review-item-date">{{ review.created_at|date:'Y.m.d' }}</span>
                                    </div>
                                    {% with images=review.images.all %}
                                        {% if images %}
                                            <div class="customer-review-item-images">
                                                {% for image in images %}
                                                    <img src="{{ image.image.url }}" alt="리뷰 이미지">
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                    <div class="customer-review-item-body">
                                        <span class="customer-review-item-content">{{ review.content }}</span>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mobile-purchase-drawer" id="mobilePurchaseDrawer">
    <div class="drawer-overlay" id="drawerOverlay"></div>
    <div class="drawer-content">
        <div class="drawer-header">
            <h3>구매 옵션</h3>
            <button class="drawer-close" id="drawerClose">×</button>
        </div>
        
        <div class="drawer-body">
            <div class="drawer-product-info">
                <div class="drawer-product-details">
                    <h4 class="drawer-product-name">{{ products.name }}</h4>
                    <p class="drawer-product-price">
                        {% if products.sale_price %}
                            <span class="unit-price" data-price="{{ products.price|discount_amount:products.sale_price }}"><span class="total-price" id="drawerTotalPrice">{{ products.price|discount_amount:products.sale_price|intcomma }}원</span>
                        {% else %}
                            <span class="unit-price" data-price="{{ products.price }}"><span class="total-price" id="drawerTotalPrice">{{ products.price|intcomma }}원</span>
                        {% endif %}
                    </p>
                </div>
            </div>
            <div class="drawer-color-section">
                <div class="drawer-color-options">
                    {% for color in products.colors.all %}
                    <button class="drawer-color-option-btn" data-color="{{ color.id }}">
                        <span class="drawer-color-circle" style="background-color: {% if color.hex_code %}{{ color.hex_code }}{% else %}#e5e7eb{% endif %};"></span>
                    </button>
                    {% endfor %}
                </div>
            </div>
            <div class="drawer-options-row">
                {% if products.sizes.exists %}
                <div class="drawer-size-section">
                    <h5>사이즈</h5>
                    <div class="drawer-size-options">
                        {% for size in products.sizes.all %}
                        <button type="button" class="drawer-size-btn" data-size="{{ size.name }}" data-size-id="{{ size.id }}">{{ size.name }}</button>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="drawer-quantity-section">
                    <h5>수량</h5>
                    <div class="drawer-quantity-controls">
                        <button class="drawer-quantity-btn" onclick="decreaseDrawerQuantity()">-</button>
                        <span class="drawer-quantity-display" id="drawerQuantityDisplay">1</span>
                        <button class="drawer-quantity-btn" onclick="increaseDrawerQuantity()">+</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="drawer-footer">
            <div class="drawer-actions">
                <button class="drawer-btn drawer-btn-primary" id="drawerBuyBtn" onclick="handleDrawerBuy()">구매하기</button>
                {% if products.is_live and not products.is_sold %}
                    {% if user.is_authenticated %}
                        <form method="post" action="{% url 'cart-create' %}" class="drawer-cart-form">
                            {% csrf_token %}
                            <input type="hidden" name="product_id" value="{{ products.id }}">
                            <input type="hidden" name="quantity" id="drawerCartQuantity" value="1">
                            {% if products.colors.first %}
                            <input type="hidden" name="color_id" id="drawerSelectedColorId" value="{{ products.colors.first.id }}">
                            {% else %}
                            <input type="hidden" name="color_id" id="drawerSelectedColorId" value="">
                            {% endif %}
                            <input type="hidden" name="size_id" id="drawerSelectedSizeId" value="">
                            <button type="submit" class="drawer-btn drawer-btn-secondary">장바구니</button>
                        </form>
                    {% else %}
                        <form method="get" action="{% url 'login' %}" class="drawer-cart-form">
                            <button type="submit" class="drawer-btn drawer-btn-secondary">장바구니</button>
                        </form>
                    {% endif %}
                    
                    {% if user.is_authenticated %}
                        <button type="button" class="drawer-btn drawer-btn-icon" onclick="addToWishlist({{ products.id }})" id="drawerWishlistBtn">
                            {% if is_favorited %}★{% else %}☆{% endif %}
                        </button>
                    {% else %}
                        <button type="button" class="drawer-btn drawer-btn-icon" onclick="window.location.href='{% url 'login' %}'">☆</button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<button class="mobile-fab-btn" id="mobileFabBtn">
    <span>구매하기</span>
</button>

<div class="review-write-modal" id="reviewWriteModal">
    <div class="review-write-modal-overlay" onclick="closeReviewModal()"></div>
    <div class="review-write-modal-content">
        <div class="review-write-modal-header">
            <h3>리뷰 작성</h3>
            <button type="button" class="review-write-modal-close" onclick="closeReviewModal()">×</button>
        </div>
        <form method="post" action="{% url 'review-create' product_id=products.id %}" enctype="multipart/form-data" class="review-write-form">
            {% csrf_token %}
            <div class="review-write-product-info">
                <div class="review-write-product-image">
                    {% if products.image.first %}
                    <img src="{{ products.image.first.image.url }}" alt="{{ products.name }}">
                    {% endif %}
                </div>
                <div class="review-write-product-name">{{ products.name }}</div>
            </div>
            
            <div class="review-write-rating">
                <label class="review-write-label">평점</label>
                <div class="review-write-stars">
                    {% for i in "54321" %}
                    <input type="radio" name="rating" value="{{ i }}" id="rating{{ i }}" {% if i == "5" %}checked{% endif %}>
                    <label for="rating{{ i }}" class="review-star-label">★</label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="review-write-content">
                <label class="review-write-label">리뷰 내용</label>
                <textarea name="content" placeholder="상품에 대한 솔직한 리뷰를 작성해주세요 (최소 10자 이상)" rows="5" minlength="10" maxlength="1000" required></textarea>
            </div>
            
            <div class="review-write-images">
                <label class="review-write-label">사진 첨부 (선택)</label>
                <input type="file" name="image" accept="image/*" multiple>
                <p class="review-write-hint">최대 5장까지 첨부 가능합니다</p>
            </div>
            
            <div class="review-write-actions">
                <button type="button" class="review-write-cancel" onclick="closeReviewModal()">취소</button>
                <button type="submit" class="review-write-submit">리뷰 등록</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="{% static 'js/products/product-description-or-review.js' %}"></script>
<script src="{% static 'js/products/detail.js' %}"></script>
<script src="{% static 'js/products/review_rating.js' %}"></script>
<script src="{% static 'js/products/size_quantity.js' %}"></script>
<script src="{% static 'js/favorites/favorite.js' %}"></script>
<script>
      window.reviewData = [
          {% for review in reviews %}
          {
              id: {{ review.id }},
              username: "{{ review.get_masked_username }}",
              first_name: "{{ review.user.first_name|default:review.get_masked_username }}",
              rating: "{{ review.get_star_display }}",
              content: "{{ review.content|escapejs }}",
              date: "{{ review.created_at|date:'Y.m.d' }}",
              hasProfileImage: {% if review.user.profile_image %}true{% else %}false{% endif %},
              profileImage: {% if review.user.profile_image.url %}"{{ review.user.profile_image }}"{% else %}null{% endif %},
              images: [
                  {% for image in review.images.all %}
                  "{{ image.image.url }}"{% if not forloop.last %},{% endif %}
                  {% endfor %}
              ],
              productImages: [
                  {% for image in products.image.all %}
                  "{{ image.image.url }}"{% if not forloop.last %},{% endif %}
                  {% endfor %}
              ]
          }{% if not forloop.last %},{% endif %}
          {% endfor %}
      ];
</script>
<script src="{% static 'js/products/review_3d.js' %}"></script>
{% endblock %}